# Innodb存储引擎事务四个特性（ACID）
* 原子性（atomicity）
* 一致性（consisency）
* 隔离性（isolation）
* 持久性（durablity）

# 事务的实现
* 事务的个隔离由锁来实现。通过数据库的redo log（重做日志）用来保证事务的原子和持久性和 undo log用来保证事务一致性。
* redo 恢复提交事务修改的页操作，而undo回滚行记录到某个特定版本。因此两者记录内容不同，redo通常是物理日志，记录的是页的物理修改操作。undo是逻辑日志，根据每行记录记性记录
### redo
* 概念：重做日志用来实现事务的持久性，由两部分组成：
* 1.内存中的重做日志缓冲（redo log buffer），易失
* 2.重做日志文件（redo log file），持久。
* Innodb通过Force Log at Commit机制实现事务的持久性，即当事务提交时，必须先将事务的所有日志写入到重做日志文件进行持久化。这里的日志指重做日志，
两部分组成，redo log 和 undo log
* redo log用来保证事务的持久性。undo log用来帮助事务回滚及mvcc的功能。redo log基本是顺序写的，在数据库运行时不需要对	redo log的文件进行读取操作。而undo log是需要进行随机读写的
* 为了确保日志都写入重做日志文件，在每次重做日志缓冲写入重做日志文件后，Innodb存储引擎都需要调用一次fsync操作。
* Innodb存储引擎允许用户手动设置非持久性的情况发生，由此提高数据库性能。即当事务提交时，日志不写入重做日志文件，而是等待一个时间周期后再执行fsync操作。
* 参数innodb_flush_log_at_trx_commit用来控制重做日志刷新到磁盘的策略。该参数默认值1，表示事务提交时必须调用一次fsync。可以设置成0和2，
0表示事务提交时不写入重做日志操作，这个操作尽在master thread中完成。而master thread中每一秒会进行一次重做日志文件的fsync操作。
2表示事务提交时将重做日志写入重做日志文件，但仅写入文件系统的缓存中，不进行fsync操作
* **重做日志和二进制日志区别**
* 1.重做日志是Innodb存储引擎层产生的，而二进制日志是在mysql数据库的上层产生的。
* 2.两种日志的内容形式不同，Mysql数据库上层的二进制日志是一种逻辑日志，其次对应的是sql语句。而重做日志是物理格式日志，其记录的是对每个页的修改。
* 3.两种日志的写入时间点不同，二进制日志只在事务提交完成后一次性写入。而重做日志实在事务进行中不断被写入，这表现为日志并不是随事务提交的顺序进行写入的。
* log block
* 在Innodb存储引擎中，重做日志都是以512字节进行存储的。这意味着重做日志缓存、重做日志文件都是以块（block）的方式进行保存的，称之为重做日志块（redo log block），每块大小512字节
* 日志块由3部分组成：日志块头（log block header）12字节，日志内容（log body）492字节，日志块尾（log block tailer）8字节。
* log group 重做日志组，其中有多个重做日志文件。
* 重做日志格式：
* Innodb存储引擎的存储管理是基于页的，故其重做日志格式也是基于页的。虽然有着不同的重做日志格式，但是他们有着通用的头部格式。

|-|-|-|-|
|-|-|-|-|
|redo_log_type|space|page_no|redo log body|

* 通用的头部格式由下面三个部分组成：
* redo_log_type :重做日志类型
* space：表空间id
* page_no:页的偏移量

### undo
* 重做日志记录了事务的行为，可以很好的通过页进行“重做”操作。但是事务又是还需要进行回滚操作，这时需要undo。
* 因此在数据库进行修改时，Innodb存储引擎不但会产生redo，还会产生一定量的undo。
* redo存放在重做日志文件中，与redo不同，undo存放在数据库内部一个特殊段（segment），这个段称为undo段（undo segment）。undo段位于共享表空间内
* undo除了回滚，其另外一个作用是MVCC，即在Innodb存储引擎中MVCC的实现是通过undo来完成。

### purge
* purge用于最终的完成的delete和update操作。Innodb支持MVCC，所以记录不能在事务提交时立即进行处理。这时，其他事物可能正在引用这行，故Innodb存储引擎需要保存记录之前的版本，
而是否可以删除这条记录通过purge来进行判断。若该行记录已不被任何其他事务引用，那么就可以进行真正的delete操作。	
